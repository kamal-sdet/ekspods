apiVersion: apps/v1
kind: Deployment
metadata:
  name: influxdb
  namespace: {{ MONITORING_NAMESPACE }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: influxdb

  revisionHistoryLimit: 0

  template:
    metadata:
      labels:
        app: influxdb

    spec:
      # ðŸ‘‡ RUN INFLUXDB ONLY ON MONITORING NODEGROUP
      nodeSelector:
        eks.amazonaws.com/nodegroup: monitoring-nodes

      containers:
      - name: influxdb
        image: influxdb:1.8

        env:
        - name: INFLUXDB_DB
          value: jmeter
        - name: INFLUXDB_HTTP_AUTH_ENABLED
          value: "false"

        ports:
        - containerPort: 8086  # HTTP API
        - containerPort: 8088  # Backup/Restore

        # ðŸ”¥ POSTSTART HOOK â€” REPLACES INIT CONTAINER
        lifecycle:
          postStart:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  echo "â³ Waiting for InfluxDB API...";
                  until curl -s http://localhost:8086/ping > /dev/null; do sleep 2; done;
                  echo "ðŸ›  Creating 'jmeter' DB if not exists...";
                  curl -s -XPOST "http://localhost:8086/query" --data-urlencode "q=CREATE DATABASE jmeter";
                  echo "âœ” Database ready!";

        readinessProbe:
          httpGet:
            path: /ping
            port: 8086
          initialDelaySeconds: 4
          periodSeconds: 3

        livenessProbe:
          httpGet:
            path: /ping
            port: 8086
          initialDelaySeconds: 
